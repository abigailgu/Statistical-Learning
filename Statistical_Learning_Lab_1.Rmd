---
title: "Statistical_Learning_Lab_1"
author: "Gutman Abigail & Shalom Shahar"
date: "22 3 2021"
output: html_document
---
#הורדת ספריות 
```{r setup, include=FALSE}
# tools and data upload
library(ggplot2)
library(dplyr)
library(scales) # needed for formatting y-axis labels to non-scientific type
library(tidyr)
library(tidyverse)
library(ggthemes)
library(datasets)
library(nycflights13)
library(kableExtra) #table styling
library(e1071) # kurtosis and skeeness
library(MASS) # reg modeling
library(corrplot)
library(caTools)
library(plotly)
library(lubridate)
library(hexbin)
library(usmap)
```

```{r}
options(scipen = 999)
flights <- as.data.frame(nycflights13::flights)
wheather <- nycflights13::weather
airports <- nycflights13::airports
planes <- nycflights13::planes
```

```{r, echo=FALSE, results='asis',fig.keep='all'}
#summary(flights)
flights_con <- flights[,c(2:9, 11 ,15:19)]
flights_catgory <- flights[,c(10 ,12:15)]

catgory <- colnames(flights_catgory) 
carrier <- flights_catgory %>% count(carrier)# helpful
kable(carrier, row.names = F) %>% kable_styling()

tailnum <-flights_catgory %>% count(tailnum)
kable(tailnum, row.names = F) %>% kable_styling()

origin <- flights_catgory %>% count(origin) #helpful
kable(origin, row.names = F) %>% kable_styling()

dest <- flights_catgory %>% count(dest) # need to check
kable(dest, row.names = F) %>% kable_styling()

air_time <- flights_catgory %>% count(air_time)#need to check
kable(air_time, row.names = F) %>% kable_styling()

countinuous <- colnames(flights_con)
ggplot(data = flights_con) +
  geom_bar(mapping = aes(x = month))  # 2 חשוד

ggplot(data = flights_con) +
  geom_bar(mapping = aes(x = day))  # 30 לחודש חשוד

ggplot(data = flights, mapping = aes(x = dep_time/100)) + 
  geom_histogram(binwidth = 0.25) # טיסות שממריאות בלילה ?

ggplot(data = flights, mapping = aes(x = arr_time/100)) + 
  geom_histogram(binwidth = 0.25)  # טיסות שמגיעות בלילה?


ggplot(data = flights, mapping = aes(x = sched_dep_time/100)) + 
  geom_histogram(binwidth = 0.25)

ggplot(data = flights, mapping = aes(x = dep_delay)) + 
  geom_histogram(binwidth = 1) + xlim(0,300)
dep_delay_over <- flights %>% filter(dep_delay > 300)


ggplot(data = flights, mapping = aes(x = arr_delay)) + 
  geom_histogram(binwidth = 1) + xlim(0,300)
arr_delay_over <- flights %>% filter(arr_delay > 300)


ggplot(data = flights, mapping = aes(x = sched_arr_time/100)) + 
  geom_histogram(binwidth = 0.25)

ggplot(data = flights, mapping = aes(x = flight)) + 
  geom_histogram(binwidth = 1) # מזהה טיסה

ggplot(data = flights, mapping = aes(x = distance)) + 
  geom_histogram(binwidth = 1) + xlim (0,2000)
long_dist <- flights %>% filter(distance > 2000)
```

# **1 Graph Critique**
### Q1:
The first graph shows us the percentage of flights that departed over a 15-minute delay divided into each destination individually.
The purpose of this graph is to make the reader's eye quickly find the percentage of flights based on a visualization of the United States map.

The second graph shows the weekly flight cycles throughout 2008 where the blue line indicates the total number of flights that took off that day and the red line indicates the number of flights in which there was a delay of over 15 minutes.

### Q2:
In the first graph the information is not presented in an ideal way, it is difficult for the reader to identify where each line is coming from, although it is possible to understand which countries it is but it is not always possible to identify exactly which airport it is.

In the second graph, in our opinion, the amount of lines and points confuses the reader and makes it difficult for him to identify the patterns of flight delays throughout the seasons.
In addition, the information overload makes it difficult to identify recurring latency patterns on certain days for the length of the weekly / monthly cycle.

### Q3:
The first graph raises the obvious question: Are there countries where the average latency is higher than in other countries? In addition, which are the airports where the percentage of delays is higher?
Another question is whether the percentages of delay measured vary according to the seasons?

The second graph raises the questions: Are there patterns of lateness that recur on certain days of the week or in a particular season, or are there lateness in some months than in other months?
In addition, if the observation was lower by day / month, it would be possible to compare percentages and learn from the data by comparing proportions.

### Q4:
The first graph can be improved by changing the graph to a dynamic graph. This means that when the mouse points to a certain line, we will be presented with the values of the airport we are pointing to.

In the second graph it was possible to improve the visualization by changing the red bars to a long line connecting the dots which makes it possible to identify patterns in the delays of the flights.



# **2 Reproducing these analyses**


1. A graphic summarizing the flight volume and flights delayed, broken by day and showing weekly cycles.
```{r fig3, fig.width = 15, fig.asp = .32, warning=F}
#EWR/ LGA/ JFK to choose
week_cycles <- as.data.frame(flights) %>% filter(origin == 'EWR') %>% dplyr::select(time_hour ,dep_delay ,sched_dep_time)
week_cycles$time_hour <- as.Date(week_cycles$time_hour)
week_cycles<- week_cycles %>% mutate(delay = if_else(dep_delay <= 15 ,0,1,0))


week_cycles_freq <- week_cycles %>% group_by(time_hour) %>% summarise(frequency = n())
week_cycles_delay <- week_cycles %>% group_by(time_hour) %>% summarise(sum(delay))
l <- length(week_cycles_freq$frequency)
week_cycles_min <- week_cycles_freq[c(2:(l-1)),]
week_cycles_min <- week_cycles_min %>% mutate(local_min = (week_cycles_min$frequency == runmin(week_cycles_min$frequency,length(week_cycles_min$frequency)/2)))  
week_cycles_min <- week_cycles_min %>% filter(local_min == T) %>% filter(frequency < 250)


ggplot(data = week_cycles_freq,aes(x = time_hour,
                                   y= week_cycles_freq$frequency,colour = "blue")) +
  geom_point() + geom_line(aes(color = "blue")) +
  geom_point(data = week_cycles_delay,aes(x=time_hour,y= `sum(delay)`), color ='red') +
  geom_linerange(data = week_cycles_delay,aes(x= time_hour, ymax =`sum(delay)` ,ymin=0,color = 'red')) +
  geom_point(data = week_cycles_min,aes(x=time_hour,y=week_cycles_min$frequency,
                                         color = "lightblue"),size = 7)+
    scale_color_identity(name ="" ,breaks = c("blue","red","lightblue"),
                       labels = c("All Flights (scheculed for departure)",
                                  "Late Flights (departure delayed >15)", "Fewer flights"),
                          guide =  guide_legend(override.aes = list(linetype = c(1, 1, 0),
                                                                    shape = c(NA,NA,16),
                                                                    size = c(1,1,7)))) + 
  theme_light()  +
  xlab("Date")+ ylab("Flights per day") +
  theme(legend.position="top",legend.direction = "vertical") +
  ggtitle(label = "Weekly Cycles", subtitle = "the airport, we need to choose, Year = 2013") +
  theme(plot.title = element_text(hjust = 0.5,size = 20),plot.subtitle = element_text(hjust = 0.5,size = 15)) 


```

the other graph, flight percent
```{r}
dep_delay <- as.data.frame(flights) %>% filter(origin == 'EWR') %>%
  mutate(delay = if_else(dep_delay <= 15 ,0,1,0)) %>% group_by(faa = dest) %>% summarise(amount = (frequency = n()), dep = sum(delay)) %>% mutate(per = dep/amount)

```


```{r}
dep_delay_loc <- dep_delay %>% left_join(airports, by = "faa") %>% drop_na()
# removed : STT,SJU, BQN need to be explain why they can be found.
dep_delay_loc <- dep_delay_loc %>% mutate(per_ch = NA)
dep_delay_loc$per_ch[dep_delay_loc$per <= 0.10 ] <- "<= 10%"
dep_delay_loc$per_ch[dep_delay_loc$per <= 0.15 & dep_delay_loc$per > 0.10 ] <- "10% - 15%"
dep_delay_loc$per_ch[dep_delay_loc$per <= 0.20 & dep_delay_loc$per > 0.15 ] <- "15% - 20%"
dep_delay_loc$per_ch[dep_delay_loc$per <= 0.25 & dep_delay_loc$per > 0.20 ] <- "20% - 25%"
dep_delay_loc$per_ch[dep_delay_loc$per >= 0.25] <- "25% <="
dep_delay_loc$per_ch <- factor(dep_delay_loc$per_ch, levels = c("<= 10%","10% - 15%",
                                                         "15% - 20%","20% - 25%","25% <="))


```

```{r}



geo <- list(
  scope = "usa",
  projection = list(type = "albers usa"),
  landcolor = toRGB("gray95"), showlegend = FALSE,
  countrycolor = toRGB("gray80"))

fig <- plot_geo(locationmode ="ISO-3", color = ~per_ch)

fig <- fig %>% add_markers(
  data = dep_delay_loc, x = ~lon, y = ~lat,
  showlegend = FALSE)

fig <- fig %>% add_segments(
    data = dep_delay_loc,
    x =-74.16867, xend = ~lon,
    y = 40.6925, yend = ~lat,  size = I(1),text = ~name, hoverinfo = "text" )

fig <- fig %>% layout(
    title = list(text= '<b>% of Flight Departures Delayed > 15 Min</b><br>Airport = EWR    Year = 2013'),
                 geo = geo, height=500)
fig <- fig %>% layout(legend = list(x = 0.1, y = -0.4))  %>%
  layout(legend=list(title=list(text='<b> Percent range </b>'))) %>%
  add_trace(data = dep_delay_loc ,type = "scattergeo",text = ~ faa , mode = "text", showlegend = FALSE)

fig

```

```{r}

plot_usmap(regions = "states",labels = TRUE,exclude =  c("AK","HI"), size = 0.5,
           label_color = "grey",
           color = "grey") + 
    theme(panel.background=element_blank()) +
  geom_segment(data = dep_delay_loc, aes(x = lon,y = lat, xend = -74.16867,
                                         yend = 40.6925 ,colour = per_ch),size = 1) + 
  geom_point(data = dep_delay_loc, aes(x = lon , y = lat, colour =  per_ch),
             size = 1.5, show.legend = F) +
  scale_color_manual(name = "",values = c("green","purple","blue","orange","red"),
                     guide =  guide_legend(override.aes = list(linetype = c(1, 1, 1,1,1),
                                                               size = c(1.5,1.5,1.5,1.5,1.5)))) +
    labs(title = '% of Flight Departures Delayed > 15 Min',
          subtitle = 'Airport = EWR Year = 2013') +
      theme(plot.title = element_text(hjust = 0.5,size = 20),
          plot.subtitle = element_text(hjust = 0.5,size = 15)) 










```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.




# **3. Freestyle analysis:**

The first graph shows the relationship between visibility and flight delays.
```{r, warning=F, message=F}
flights_delayed <- filter(flights, dep_delay >0 ) #We want to see only the delayed flights 
flights_delayed1 <- flights_delayed %>%  group_by(time_hour) %>% summarise(Avg_dep_delay = mean(dep_delay))

Wheather_cond <- left_join(flights_delayed1, wheather) #combine the two relevant data frames 

visib_df <- Wheather_cond %>% group_by(visib) %>% summarise(Avg_dep_delay = mean(Avg_dep_delay))

ggplot(data = visib_df, mapping = aes(x = visib, y = Avg_dep_delay)) + geom_point(color = "violetred4") + 
  geom_smooth(method = "lm", fill = "violet", color = "violetred4") +
  labs(x = "visibility", y="Average Departure Delay Time (minutes)", 
       title = "Average Departure Delay vs. Quality of visibility")
```
When we tried to think what was the main reason for the delay of flights the first thing that came to our mind was the weather conditions.
When we studied the weather database we noticed a variable called "visib" and decided to try to understand the relationship between visibility and flight delays.
The graph shown above shows a direct relationship between the quality of visibility and the average flight delay in minutes. The better the visibility, the smaller the average delays.



The second graph

לא עבד נמשיך מחר :(( ))
```{r}
flights_delayed2 <- filter(flights, arr_delay >0 )
merges_planes <- merge(flights, planes, by = "tailnum")
merges_planes <- mutate(merges_planes, Age = year.x - year.y) %>%  mutate(Age = if_else(Age > 25, 25L, Age))

flights_delayed_plane <- merges_planes %>% group_by(Age) %>% summarise(Avg_dep_delay = mean(arr_delay, na.rm = T), n = n_distinct(arr_delay, na.rm = T)) %>% filter(!is.na(Age)) 
flights_delayed_plane <- filter(flights_delayed_plane, n >30)

ggplot(data = flights_delayed_plane, mapping = aes(x = Age, y = Avg_dep_delay)) + geom_point(color = "violetred4") + geom_smooth( fill = "violet", color = "violetred4")


ggplot(data = merges_planes) +
  geom_boxplot(mapping = aes(x = manufacturer, y = dep_delay)) +   coord_flip()
```





# **4. Graphical Lineup:**

```{r}
by_month <- flights_delayed %>% group_by(month) %>% summarise(n = n_distinct(dep_delay), avg_delay = mean(dep_delay))

#by_month$month <- as.character.Date(by_month$month)
n_avg <- mean(by_month$n)
dep_delay_avg <- mean(by_month$avg_delay)

x1 <- runif(n_avg, min = min(by_month$avg_delay), max = max(by_month$avg_delay))

ggplot(by_month) + geom_line(mapping = aes(x = month, y = avg_delay))
```


