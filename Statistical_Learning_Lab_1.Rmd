---
title: "Statistical_Learning_Lab_1"
author: "Gutman Abigail & Shalom Shahar"
date: "22 3 2021"
output: html_document
---

```{r setup, include=FALSE}
# tools and data upload
library(ggplot2)
library(dplyr)
library(scales) # needed for formatting y-axis labels to non-scientific type
library(tidyr)
library(tidyverse)
library(ggthemes)
library(datasets)
library(nycflights13)
library(kableExtra) #table styling
library(e1071) # kurtosis and skeeness
library(MASS) # reg modeling
library(corrplot)
library(caTools)
library(plotly)
```

```{r}
options(scipen = 999)
flights <- as.data.frame(nycflights13::flights)
wheather <- nycflights13::weather
airports <- nycflights13::airports
planes <- nycflights13::planes
```

```{r, echo=FALSE, results='asis',fig.keep='all'}
#summary(flights)
flights_con <- flights[,c(2:9, 11 ,15:19)]
flights_catgory <- flights[,c(10 ,12:15)]

catgory <- colnames(flights_catgory) 
carrier <- flights_catgory %>% count(carrier)# helpful
kable(carrier, row.names = F) %>% kable_styling()

tailnum <-flights_catgory %>% count(tailnum)
kable(tailnum, row.names = F) %>% kable_styling()

origin <- flights_catgory %>% count(origin) #helpful
kable(origin, row.names = F) %>% kable_styling()

dest <- flights_catgory %>% count(dest) # need to check
kable(dest, row.names = F) %>% kable_styling()

air_time <- flights_catgory %>% count(air_time)#need to check
kable(air_time, row.names = F) %>% kable_styling()

countinuous <- colnames(flights_con)
ggplot(data = flights_con) +
  geom_bar(mapping = aes(x = month))  # 2 חשוד

ggplot(data = flights_con) +
  geom_bar(mapping = aes(x = day))  # 30 לחודש חשוד

ggplot(data = flights, mapping = aes(x = dep_time/100)) + 
  geom_histogram(binwidth = 0.25) # טיסות שממריאות בלילה ?

ggplot(data = flights, mapping = aes(x = arr_time/100)) + 
  geom_histogram(binwidth = 0.25)  # טיסות שמגיעות בלילה?


ggplot(data = flights, mapping = aes(x = sched_dep_time/100)) + 
  geom_histogram(binwidth = 0.25)

ggplot(data = flights, mapping = aes(x = dep_delay)) + 
  geom_histogram(binwidth = 1) + xlim(0,300)
dep_delay_over <- flights %>% filter(dep_delay > 300)


ggplot(data = flights, mapping = aes(x = arr_delay)) + 
  geom_histogram(binwidth = 1) + xlim(0,300)
arr_delay_over <- flights %>% filter(arr_delay > 300)


ggplot(data = flights, mapping = aes(x = sched_arr_time/100)) + 
  geom_histogram(binwidth = 0.25)

ggplot(data = flights, mapping = aes(x = flight)) + 
  geom_histogram(binwidth = 1) # מזהה טיסה

ggplot(data = flights, mapping = aes(x = distance)) + 
  geom_histogram(binwidth = 1) + xlim (0,2000)
long_dist <- flights %>% filter(distance > 2000)
```


# **1 Graph Critique**
### Q1:
The first graph shows us the percentage of flights that departed over a 15-minute delay divided into each destination individually.
The purpose of this graph is to make the reader's eye quickly find the percentage of flights based on a visualization of the United States map.

The second graph shows the weekly flight cycles throughout 2008 where the blue line indicates the total number of flights that took off that day and the red line indicates the number of flights in which there was a delay of over 15 minutes.

### Q2:
In the first graph the information is not presented in an ideal way, it is difficult for the reader to identify where each line is coming from, although it is possible to understand which countries it is but it is not always possible to identify exactly which airport it is.

In the second graph, in our opinion, the amount of lines and points confuses the reader and makes it difficult for him to identify the patterns of flight delays throughout the seasons.
In addition, the information overload makes it difficult to identify recurring latency patterns on certain days for the length of the weekly / monthly cycle.

### Q3:
The first graph raises the obvious question: Are there countries where the average latency is higher than in other countries? In addition, which are the airports where the percentage of delays is higher?
Another question is whether the percentages of delay measured vary according to the seasons?

The second graph raises the questions: Are there patterns of lateness that recur on certain days of the week or in a particular season, or are there lateness in some months than in other months?
In addition, if the observation was lower by day / month, it would be possible to compare percentages and learn from the data by comparing proportions.

### Q4:
The first graph can be improved by changing the graph to a dynamic graph. This means that when the mouse points to a certain line, we will be presented with the values of the airport we are pointing to.

In the second graph it was possible to improve the visualization by changing the red bars to a long line connecting the dots which makes it possible to identify patterns in the delays of the flights.



# **2 Reproducing these analyses**
צריך עוד לייצר פה נק מינמום מקומי אינעל העולם לא יודעת איך הוא רוצה את זה מה

1. A graphic summarizing the flight volume and flights delayed, broken by day and showing weekly cycles.
```{r fig3, fig.width = 15, fig.asp = .32, warning=F}
#EWR/ LGA/ JFK to choose
week_cycles <- as.data.frame(flights) %>% filter(origin == 'EWR') %>% dplyr::select(time_hour ,dep_delay ,sched_dep_time)
week_cycles$time_hour <- as.Date(week_cycles$time_hour)
week_cycles<- week_cycles %>% mutate(delay = if_else(dep_delay <= 15 ,0,1,0))

week_cycles_freq <- week_cycles %>% group_by(time_hour) %>% summarise(frequency = n())
week_cycles_delay <- week_cycles %>% group_by(time_hour) %>% summarise(sum(delay))
week_cycles_min <- week_cycles_freq %>% mutate(local_min = (week_cycles_freq$frequency == runmin(week_cycles_freq$frequency,length(week_cycles_freq$frequency)/2)))  
week_cycles_min <- week_cycles_min %>% filter(local_min == T)


ggplot(data = week_cycles_freq,aes(x = time_hour,
                                   y= week_cycles_freq$frequency,colour = "blue")) +
  geom_point(aes(color = "blue")) + geom_line(color = "blue") +
  geom_point(data = week_cycles_delay,aes(x=time_hour,y= `sum(delay)`, color ='red')) +
  geom_linerange(data = week_cycles_delay,aes(x= time_hour, ymax =`sum(delay)` ,ymin=0),color = 'red') +
    scale_color_identity(name ="" ,breaks = c("blue","red"),
                       labels = c("All Flights (scheculed for departure)",
                                  "Late Flights (departure delayed >15)"),
                          guide = "legend") +
  theme_light()  +
  xlab("Date")+ ylab("Flights per day") +
  theme(legend.position="top",legend.direction = "vertical") +
  ggtitle(label = "Weekly Cycles", subtitle = "the airport, we need to choose, Year = 2013") +
  theme(plot.title = element_text(hjust = 0.5,size = 20),plot.subtitle = element_text(hjust = 0.5,size = 15)) 
#need to takecare in the point of the locl minmun
```

the other graph, flight percent
```{r}
dep_delay <- as.data.frame(flights) %>% filter(origin == 'EWR') %>%
  mutate(delay = if_else(dep_delay <= 15 ,0,1,0)) %>% group_by(faa = dest) %>% summarise(amount = (frequency = n()), dep = sum(delay)) %>% mutate(per = dep/amount)

```


```{r}
dep_delay_loc <- dep_delay %>% left_join(airports, by = "faa") %>% drop_na()
# removed : STT,SJU, BQN need to be explain why they can be found.
dep_delay_loc <- dep_delay_loc %>% mutate(per_ch = NA)
dep_delay_loc$per_ch[dep_delay_loc$per <= 0.10 ] <- "<= 10%"
dep_delay_loc$per_ch[dep_delay_loc$per <= 0.15 & dep_delay_loc$per > 0.10 ] <- "10% - 15%"
dep_delay_loc$per_ch[dep_delay_loc$per <= 0.20 & dep_delay_loc$per > 0.15 ] <- "15% - 20%"
dep_delay_loc$per_ch[dep_delay_loc$per <= 0.25 & dep_delay_loc$per > 0.20 ] <- "20% - 25%"
dep_delay_loc$per_ch[dep_delay_loc$per >= 0.25] <- "25% <="


```

```{r}
geo <- list(
  scope = "north america",
  projection = list(type = "albers usa"),
  landcolor = toRGB("gray95"),
  countrycolor = toRGB("gray80"))

fig <- plot_geo(locationmode ="world", color = ~per_ch)
fig <- fig %>% add_markers(
  data = dep_delay_loc, x = ~lon, y = ~lat, text = ~name,
  hoverinfo = "text")

fig <- fig %>% add_segments(
    data = dep_delay_loc,
    x =-74.16867, xend = ~lon,
    y = 40.6925, yend = ~lat,  size = I(1), hoverinfo = "text")

fig <- fig %>% layout(
    title = '% of Flight Departures Delayed > 15 Min<br>(Hover for airport names)',
    geo = geo, height=800)


fig

```

```{r}


```

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.




# **3. Freestyle analysis:**
```{r, warning=F}
summary(flights)
#בדיקת המשתנים הקטגוריים אל מול המשתנים הרציפיים - למטרת למידת הנתונים 
ggplot(data = flights, mapping = aes( x = hour, y = air_time)) +ylim = c(0, 500)
  geom_boxplot(mapping = aes(group = cut_width(hour,0.1))) +coord_cartesian(xlim = c(1, 24))



# dep_time
# sched_dep_time
# dep_delay
# arr_time
# sched_arr_time
# arr_delay
# air_time    

ggplot(data = flights, mapping = aes( x = day, y = arr_delay)) +
  geom_point(mapping = aes(group = cut_width(day,0.1))) +coord_cartesian(xlim = c(1, 24), ylim = c(0,500))
```


# **4. Graphical ”Lineup:**
```{r}





```


